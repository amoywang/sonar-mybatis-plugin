<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 基础层：消息-Mapper -->
<mapper namespace="com.cndinfo.cndlct.ssp.repository.impl.message.mapper.MessagePOMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.cndinfo.cndlct.ssp.repository.impl.message.po.MessagePO">
        <id column="id" property="id"/>
        <result column="message_id" property="messageId"/>
        <result column="title" property="title"/>
        <result column="content" property="content"/>
        <result column="template_id" property="templateId"/>
        <result column="params" property="params"/>
        <result column="type" property="type"/>
        <result column="channel" property="channel"/>
        <result column="sender_type" property="senderType"/>
        <result column="sender_id" property="senderId"/>
        <result column="business_type" property="businessType"/>
        <result column="business_id" property="businessId"/>
        <result column="status" property="status"/>
        <result column="create_time" property="createTime"/>
        <result column="create_user" property="createUser"/>
        <result column="update_time" property="updateTime"/>
        <result column="update_user" property="updateUser"/>
        <result column="data_status" property="dataStatus"/>
        <result column="tenant_id" property="tenantId"/>
        <result column="version" property="version"/>
        <result column="create_user_name" property="createUserName"/>
        <result column="update_user_name" property="updateUserName"/>
        <result column="create_org" property="createOrg"/>
        <result column="company_id" property="companyId"/>
        <result column="department_id" property="departmentId"/>
        <result column="account_org_id" property="accountOrgId"/>
        <result column="staff_id" property="staffId"/>
        <result column="idx" property="idx"/>
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, message_id, title, content, template_id, params, type, channel, sender_type, sender_id, business_type,
        business_id, status, create_time, create_user, update_time, update_user, data_status, tenant_id, version,
        create_user_name, update_user_name, create_org, company_id, department_id, account_org_id, staff_id, idx
    </sql>

    <!--        分页查询消息列表-->
    <select id="queryPageList" resultType="com.cndinfo.cndlct.ssp.message.dto.response.MessagePageDTO">
        select smg.id as id,smr.id as message_recevier_id,smg.business_type as type,sm.name as
        merchant_name,smg.content,smg.create_time, smr.readed as readed from
        ssp_message smg
        left join ssp_message_receiver smr on smg.id =smr.message_id
        left join ssp_merchant sm on smr.merchant_id = sm.id
        where 1=1 and smg.type = 'business'
        <if test="userId !='' and userId !=null ">
            and smr.user_id = #{userId}
        </if>
        <if test="query.keyword !='' and query.keyword !=null ">
            and(
            content like concat('%',#{query.keyword},'%')
            or sm.name like concat('%',#{query.keyword},'%')
            )
        </if>
        <if test="query.time !=null ">
            and date_format(smg.create_time,'%Y-%m-%d') =#{query.time}
        </if>
        <if test="query.merchantIdList.size()>0 and query.merchantIdList !=null ">
            and smr.merchant_id in
            <foreach collection="query.merchantIdList"
                     item="merchantId" open="(" close=")" separator=",">
                #{merchantId}
            </foreach>
        </if>
        <if test="query.typeList.size()>0 and query.typeList !=null ">
            and smg.business_type in
            <foreach collection="query.typeList"
                     item="type" open="(" close=")" separator=",">
                #{type}
            </foreach>
        </if>
    </select>

    <select id="getMessagePageDTO" resultType="com.cndinfo.cndlct.ssp.message.dto.response.MessagePageDTO">
        select sm.id as id,smr.id as message_recevier_id, sm.`type` ,
        smh.name as merchant_name ,
        smr.readed as readed,
        sm.content as content,
        sm.create_time
        from
        ssp_message_receiver smr
        left join ssp_message sm on smr.message_id = sm.id
        left join ssp_merchant smh on smh.id =smr.merchant_id
        where sm.id = #{entity.messageId}
    </select>
</mapper>